<!DOCTYPE html>
<html>
<head>
    <title>Yearly Chart Fractal</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f8f9fa; min-height: 100vh; }
        .header { 
            background: #2d3748; 
            color: white; 
            padding: 1rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .btn-back { 
            background: #4a5568; 
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            text-decoration: none;
        }
        .btn-back:hover { background: #2d3748; }
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .admin-panel { 
            background: #fff3cd; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 30px; 
            border-left: 5px solid #d69e2e;
        }
        .admin-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: end;
        }
        .form-group { margin-bottom: 15px; }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
            color: #2d3748;
        }
        input, select { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid #e2e8f0; 
            border-radius: 6px;
        }
        .btn { 
            background: #667eea; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s;
        }
        .btn:hover { background: #5a67d8; }
        .btn-success { background: #38a169; }
        .btn-success:hover { background: #2f855a; }
        .btn:disabled { 
            background: #a0aec0; 
            cursor: not-allowed; 
        }
        
        /* Main Chart Display */
        .main-chart-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .main-chart-title {
            font-size: 24px;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .main-chart-image {
            max-width: 100%;
            height: auto;
            max-height: 400px;
            border: 3px solid #667eea;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        /* Results Section */
        .results-section { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .results-meta {
            font-size: 14px;
            color: #666;
            text-align: right;
        }
        
        /* Individual Result Items */
        .result-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.3s;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .result-item:hover {
            background: #f7fafc;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-rank {
            font-size: 18px;
            font-weight: bold;
            color: #4a5568;
            margin-right: 20px;
            min-width: 30px;
        }
        
        .result-chart-thumbnail {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-right: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .result-info {
            flex: 1;
            margin-right: 20px;
        }
        
        .result-year {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .result-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .result-score {
            text-align: center;
            min-width: 100px;
        }
        
        .similarity-score { 
            font-weight: bold; 
            font-size: 24px; 
            padding: 12px 20px; 
            border-radius: 25px; 
            color: white;
            text-align: center;
            display: inline-block;
            min-width: 80px;
            margin-bottom: 5px;
        }
        .score-high { background: #38a169; }
        .score-medium { background: #d69e2e; }
        .score-low { background: #e53e3e; }
        
        .score-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Reasoning Section */
        .reasoning-section {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 15px;
        }
        .reasoning-section h5 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .reasoning-text {
            color: #4a5568;
            line-height: 1.5;
            font-size: 13px;
        }
        
        /* Expandable reasoning */
        .result-item.expanded .reasoning-section {
            display: block;
        }
        .reasoning-section {
            display: none;
        }
        .expand-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 12px;
            text-decoration: underline;
            margin-top: 5px;
        }
        
        .loading { 
            text-align: center; 
            padding: 40px;
            color: #666;
        }
        .loading-spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status { 
            padding: 15px; 
            border-radius: 6px; 
            margin: 15px 0;
        }
        .status-success { background: #c6f6d5; color: #22543d; }
        .status-error { background: #fed7d7; color: #742a2a; }
        .status-info { background: #bee3f8; color: #2a4365; }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state h3 {
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        /* Top Results Highlight */
        .top-results {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .top-results h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .top-matches {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .top-match-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .top-match-year {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .top-match-score {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìà Yearly Chart Fractal Analysis</h1>
        <a href="/dashboard" class="btn-back">‚Üê Back to Dashboard</a>
    </div>
    
    <div class="container">
        {% if user.role == 'admin' %}
        <div class="admin-panel">
            <h3>üîß Admin Panel</h3>
            <div class="admin-controls">
                <div>
                    <div class="form-group">
                        <label>Upload 2025 Chart:</label>
                        <input type="file" id="chartFile" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>Analysis Method:</label>
                        <select id="analysisMethod">
                            <option value="gpt">GPT Vision (Recommended)</option>
                            <option value="cv">Computer Vision</option>
                        </select>
                    </div>
                </div>
                <div>
                    <button onclick="uploadChart()" class="btn" id="uploadBtn">Upload Chart</button>
                    <button onclick="runAnalysis()" class="btn btn-success" id="analyzeBtn">Run Analysis</button>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Main 2025 Chart Display -->
        {% if results %}
        <div class="main-chart-section">
            <div class="main-chart-title">
                <span>üöÄ</span>
                <span>2025 Reference Chart</span>
                <span>üöÄ</span>
            </div>
            <img src="/uploads/2025.png" alt="2025 Chart" class="main-chart-image">
        </div>
        {% endif %}
        
        <div class="results-section">
            <div class="results-header">
                <h2>üìä Historical Pattern Similarities</h2>
                {% if results %}
                <div class="results-meta">
                    <div>Last Analysis: <span data-timestamp="{{ results.timestamp | int }}">{{ results.timestamp | int }}</span></div>
                    <div>Total Comparisons: {{ results.total_comparisons }}</div>
                    <div>Successful: {{ results.successful_comparisons }}</div>
                </div>
                {% endif %}
            </div>
            
            {% if results and results.results %}
                <!-- Top 3 Results Highlight -->
                <div class="top-results">
                    <h3>üèÜ Top 3 Most Similar Years</h3>
                    <div class="top-matches">
                        {% for result in results.results[:3] %}
                        <div class="top-match-item">
                            <div class="top-match-year">{{ result.year }}</div>
                            <div class="top-match-score">{{ "%.1f"|format(result.similarity_score * 100) }}% Match</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Detailed Results List -->
                <div id="resultsList">
                    {% for result in results.results %}
                    <div class="result-item" data-year="{{ result.year }}">
                        <div class="result-rank">{{ loop.index }}</div>
                        
                        <img src="/historical/{{ result.year }}.png" 
                             alt="{{ result.year }} Chart" 
                             class="result-chart-thumbnail"
                             onclick="showFullChart('{{ result.year }}')">
                        
                        <div class="result-info">
                            <div class="result-year">{{ result.year }}</div>
                            <div class="result-description">
                                Historical chart from {{ result.year }}
                                {% if result.reasoning %}
                                <br><button class="expand-btn" onclick="toggleReasoning(this)">Show AI Analysis</button>
                                {% endif %}
                            </div>
                            {% if result.reasoning %}
                            <div class="reasoning-section">
                                <h5>üß† AI Analysis</h5>
                                <div class="reasoning-text">{{ result.reasoning }}</div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="result-score">
                            <div class="similarity-score {% if result.similarity_score > 0.7 %}score-high{% elif result.similarity_score > 0.4 %}score-medium{% else %}score-low{% endif %}">
                                {{ "%.1f"|format(result.similarity_score * 100) }}%
                            </div>
                            <div class="score-label">Similarity</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>üìä No Analysis Results Available</h3>
                    <p>{% if user.role == 'admin' %}Upload a 2025 chart and run the analysis to see results.{% else %}Admin needs to run the analysis first.{% endif %}</p>
                </div>
            {% endif %}
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <h3>üîÑ Running Analysis...</h3>
            <p>This may take several minutes. Please wait.</p>
        </div>
    </div>

    <!-- Chart Modal -->
    <div id="chartModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;" onclick="closeModal()">
        <div style="max-width: 90%; max-height: 90%; background: white; padding: 20px; border-radius: 12px;">
            <img id="modalImage" src="" alt="" style="max-width: 100%; height: auto;">
        </div>
    </div>

    <script>
        let analysisInterval = null;

        async function uploadChart() {
            const fileInput = document.getElementById('chartFile');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (!fileInput.files[0]) {
                showStatus('Please select a file', 'error');
                return;
            }
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch('/upload-2025-chart', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus(result.message, 'success');
                    fileInput.value = '';
                } else {
                    showStatus('Upload failed: ' + result.message, 'error');
                }
            } catch (error) {
                showStatus('Upload failed: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Chart';
            }
        }
        
        async function runAnalysis() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const analysisMethod = document.getElementById('analysisMethod').value;
            
            if (!confirm('This will run the full analysis and may take several minutes. Continue?')) {
                return;
            }
            
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Starting...';
            document.getElementById('loading').style.display = 'block';
            
            const formData = new FormData();
            formData.append('analysis_type', analysisMethod);
            
            try {
                const response = await fetch('/run-yearly-analysis', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus('Analysis started successfully!', 'success');
                    startProgressTracking(result.task_id);
                } else {
                    showStatus('Analysis failed: ' + result.message, 'error');
                    document.getElementById('loading').style.display = 'none';
                }
            } catch (error) {
                showStatus('Analysis failed: ' + error.message, 'error');
                document.getElementById('loading').style.display = 'none';
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Run Analysis';
            }
        }
        
        function startProgressTracking(taskId) {
            analysisInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/yearly-progress/${taskId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        clearInterval(analysisInterval);
                        document.getElementById('loading').style.display = 'none';
                        showStatus('Analysis completed successfully!', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else if (data.status === 'error') {
                        clearInterval(analysisInterval);
                        document.getElementById('loading').style.display = 'none';
                        showStatus('Analysis failed: ' + data.message, 'error');
                    }
                } catch (error) {
                    console.error('Progress tracking error:', error);
                }
            }, 3000);
        }
        
        function toggleReasoning(btn) {
            const resultItem = btn.closest('.result-item');
            const isExpanded = resultItem.classList.contains('expanded');
            
            if (isExpanded) {
                resultItem.classList.remove('expanded');
                btn.textContent = 'Show AI Analysis';
            } else {
                resultItem.classList.add('expanded');
                btn.textContent = 'Hide AI Analysis';
            }
        }
        
        function showFullChart(year) {
            const modal = document.getElementById('chartModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = `/historical/${year}.png`;
            modalImage.alt = `${year} Chart`;
            modal.style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('chartModal').style.display = 'none';
        }
        
        function showStatus(message, type) {
            // Remove existing status messages
            const existingStatus = document.querySelectorAll('.status');
            existingStatus.forEach(status => status.remove());
            
            const status = document.createElement('div');
            status.className = `status status-${type}`;
            status.textContent = message;
            
            const container = document.querySelector('.container');
            const adminPanel = document.querySelector('.admin-panel');
            
            if (adminPanel) {
                container.insertBefore(status, adminPanel.nextSibling);
            } else {
                container.insertBefore(status, container.firstChild);
            }
            
            setTimeout(() => status.remove(), 5000);
        }
        
        // Format timestamps on page load
        document.addEventListener('DOMContentLoaded', function() {
            const timestamps = document.querySelectorAll('[data-timestamp]');
            timestamps.forEach(span => {
                const timestamp = parseInt(span.dataset.timestamp);
                const date = new Date(timestamp * 1000);
                span.textContent = date.toLocaleString();
            });
        });
    </script>
</body>
</html>