<!DOCTYPE html>
<html>
<head>
    <title>Yearly Chart Fractal</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f8f9fa; min-height: 100vh; }
        .header { 
            background: #2d3748; 
            color: white; 
            padding: 1rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .btn-back { 
            background: #4a5568; 
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            text-decoration: none;
        }
        .btn-back:hover { background: #2d3748; }
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .admin-panel { 
            background: #fff3cd; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 30px; 
            border-left: 5px solid #d69e2e;
        }
        .admin-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: end;
        }
        .form-group { margin-bottom: 15px; }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
            color: #2d3748;
        }
        input, select { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid #e2e8f0; 
            border-radius: 6px;
        }
        .btn { 
            background: #667eea; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.3s;
        }
        .btn:hover { background: #5a67d8; }
        .btn-success { background: #38a169; }
        .btn-success:hover { background: #2f855a; }
        .btn:disabled { 
            background: #a0aec0; 
            cursor: not-allowed; 
        }
        .results-section { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .result-item-yearly {
            padding: 25px;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
            background: #fafafa;
            border-radius: 8px;
        }
        .yearly-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }
        .yearly-info h4 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 18px;
        }
        .yearly-info p {
            color: #666;
            line-height: 1.5;
            margin: 0;
        }
        .yearly-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }
        .yearly-chart {
            text-align: center;
        }
        .yearly-chart h5 {
            margin-bottom: 10px;
            color: #2d3748;
            font-size: 14px;
            font-weight: bold;
        }
        .yearly-chart img {
            max-width: 100%;
            height: auto;
            max-height: 200px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .vs-divider {
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            color: #667eea;
            background: white;
            padding: 10px;
            border-radius: 50%;
            border: 2px solid #667eea;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reasoning-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .reasoning-section h5 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .reasoning-text {
            color: #4a5568;
            line-height: 1.6;
            font-size: 14px;
        }
        .similarity-score { 
            font-weight: bold; 
            font-size: 1.4em; 
            padding: 10px 20px; 
            border-radius: 25px; 
            color: white;
            text-align: center;
            min-width: 80px;
        }
        .score-high { background: #38a169; }
        .score-medium { background: #d69e2e; }
        .score-low { background: #e53e3e; }
        .loading { 
            text-align: center; 
            padding: 40px;
            color: #666;
        }
        .loading-spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status { 
            padding: 15px; 
            border-radius: 6px; 
            margin: 15px 0;
        }
        .status-success { background: #c6f6d5; color: #22543d; }
        .status-error { background: #fed7d7; color: #742a2a; }
        .status-info { background: #bee3f8; color: #2a4365; }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state h3 {
            margin-bottom: 10px;
            color: #2d3748;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìà Yearly Chart Fractal Analysis</h1>
        <a href="/dashboard" class="btn-back">‚Üê Back to Dashboard</a>
    </div>
    
    <div class="container">
        {% if user.role == 'admin' %}
        <div class="admin-panel">
            <h3>üîß Admin Panel</h3>
            <div class="admin-controls">
                <div>
                    <div class="form-group">
                        <label>Upload 2025 Chart:</label>
                        <input type="file" id="chartFile" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>Analysis Method:</label>
                        <select id="analysisMethod">
                            <option value="gpt">GPT Vision (Recommended)</option>
                            <option value="cv">Computer Vision</option>
                        </select>
                    </div>
                </div>
                <div>
                    <button onclick="uploadChart()" class="btn" id="uploadBtn">Upload Chart</button>
                    <button onclick="runAnalysis()" class="btn btn-success" id="analyzeBtn">Run Analysis</button>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="results-section">
            <div class="results-header">
                <h2>Historical Comparison Results (2025 vs 2009-2024)</h2>
                {% if results %}
                <div style="font-size: 14px; color: #666;">
                    <div>Last Analysis: <span data-timestamp="{{ results.timestamp | int }}">{{ results.timestamp | int }}</span></div>
                    <div>Total Comparisons: {{ results.total_comparisons }}</div>
                </div>
                {% endif %}
            </div>
            
            {% if results and results.results %}
                <div id="resultsList">
                    {% for result in results.results %}
                    <div class="result-item-yearly">
                        <div class="yearly-header">
                            <div class="yearly-info">
                                <h4>2025 vs {{ result.year }}</h4>
                                <p>Similarity Score: {{ "%.1f"|format(result.similarity_score * 100) }}%</p>
                            </div>
                            <div class="similarity-score {% if result.similarity_score > 0.7 %}score-high{% elif result.similarity_score > 0.4 %}score-medium{% else %}score-low{% endif %}">
                                {{ "%.1f"|format(result.similarity_score * 100) }}%
                            </div>
                        </div>
                        
                        <div class="yearly-comparison">
                            <div class="yearly-chart">
                                <h5>2025 Chart</h5>
                                <img src="/uploads/2025.png" alt="2025 Chart">
                            </div>
                            <div class="vs-divider">
                                <span>VS</span>
                            </div>
                            <div class="yearly-chart">
                                <h5>{{ result.year }} Chart</h5>
                                <img src="/historical/{{ result.year }}.png" alt="{{ result.year }} Chart">
                            </div>
                        </div>
                        
                        {% if result.reasoning %}
                        <div class="reasoning-section">
                            <h5>üß† AI Analysis Reasoning</h5>
                            <div class="reasoning-text">{{ result.reasoning }}</div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>üìä No Analysis Results Available</h3>
                    <p>{% if user.role == 'admin' %}Upload a 2025 chart and run the analysis to see results.{% else %}Admin needs to run the analysis first.{% endif %}</p>
                </div>
            {% endif %}
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <h3>üîÑ Running Analysis...</h3>
            <p>This may take several minutes. Please wait.</p>
        </div>
    </div>

    <script>
        let analysisInterval = null;

        async function uploadChart() {
            const fileInput = document.getElementById('chartFile');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (!fileInput.files[0]) {
                showStatus('Please select a file', 'error');
                return;
            }
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch('/upload-2025-chart', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus(result.message, 'success');
                    fileInput.value = '';
                } else {
                    showStatus('Upload failed: ' + result.message, 'error');
                }
            } catch (error) {
                showStatus('Upload failed: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Chart';
            }
        }
        
        async function runAnalysis() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const analysisMethod = document.getElementById('analysisMethod').value;
            
            if (!confirm('This will run the full analysis and may take several minutes. Continue?')) {
                return;
            }
            
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Starting...';
            document.getElementById('loading').style.display = 'block';
            
            const formData = new FormData();
            formData.append('analysis_type', analysisMethod);
            
            try {
                const response = await fetch('/run-yearly-analysis', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus('Analysis started successfully!', 'success');
                    startProgressTracking(result.task_id);
                } else {
                    showStatus('Analysis failed: ' + result.message, 'error');
                    document.getElementById('loading').style.display = 'none';
                }
            } catch (error) {
                showStatus('Analysis failed: ' + error.message, 'error');
                document.getElementById('loading').style.display = 'none';
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Run Analysis';
            }
        }
        
        function startProgressTracking(taskId) {
            analysisInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/yearly-progress/${taskId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        clearInterval(analysisInterval);
                        document.getElementById('loading').style.display = 'none';
                        showStatus('Analysis completed successfully!', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else if (data.status === 'error') {
                        clearInterval(analysisInterval);
                        document.getElementById('loading').style.display = 'none';
                        showStatus('Analysis failed: ' + data.message, 'error');
                    }
                } catch (error) {
                    console.error('Progress tracking error:', error);
                }
            }, 3000);
        }
        
        function showStatus(message, type) {
            // Remove existing status messages
            const existingStatus = document.querySelectorAll('.status');
            existingStatus.forEach(status => status.remove());
            
            const status = document.createElement('div');
            status.className = `status status-${type}`;
            status.textContent = message;
            
            const container = document.querySelector('.container');
            const adminPanel = document.querySelector('.admin-panel');
            
            if (adminPanel) {
                container.insertBefore(status, adminPanel.nextSibling);
            } else {
                container.insertBefore(status, container.firstChild);
            }
            
            setTimeout(() => status.remove(), 5000);
        }
    </script>
</body>
</html>