<!DOCTYPE html>
<html>
<head>
    <title>Computer Vision Analysis</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f8f9fa; min-height: 100vh; }
        .header { 
            background: #2d3748; 
            color: white; 
            padding: 1rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .btn-back { 
            background: #4a5568; 
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            text-decoration: none;
        }
        .btn-back:hover { background: #2d3748; }
        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .upload-section { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: bold; 
            color: #2d3748;
        }
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 6px;
            font-size: 16px;
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #667eea; 
        }
        .btn { 
            background: #667eea; 
            color: white; 
            padding: 12px 30px; 
            border: none; 
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        .btn:hover { background: #5a67d8; }
        .btn:disabled { 
            background: #a0aec0; 
            cursor: not-allowed; 
        }
        .progress-section {
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #38a169;
            transition: width 0.3s;
            width: 0%;
        }
        .results-section {
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        .result-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-item-with-images {
            padding: 20px;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .image-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }
        .chart-side {
            text-align: center;
        }
        .chart-side h5 {
            margin-bottom: 10px;
            color: #2d3748;
            font-size: 14px;
        }
        .chart-side img {
            max-width: 100%;
            height: auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .overlay-section {
            margin-top: 15px;
            text-align: center;
        }
        .overlay-section h5 {
            margin-bottom: 10px;
            color: #2d3748;
            font-size: 14px;
        }
        .overlay-img {
            max-width: 60%;
            height: auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .similarity-score {
            font-weight: bold;
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
        }
        .score-high { background: #38a169; }
        .score-medium { background: #d69e2e; }
        .score-low { background: #e53e3e; }
        .status { 
            padding: 10px; 
            border-radius: 6px; 
            margin: 10px 0;
        }
        .status-success { background: #c6f6d5; color: #22543d; }
        .status-error { background: #fed7d7; color: #742a2a; }
        .status-info { background: #bee3f8; color: #2a4365; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé¨ Computer Vision Analysis</h1>
        <a href="/dashboard" class="btn-back">‚Üê Back to Dashboard</a>
    </div>
    
    <div class="container">
        <div class="upload-section">
            <h2>Upload Video for Analysis</h2>
            <form id="uploadForm">
                <div class="form-group">
                    <label>Video File (MP4, AVI, MOV, MKV)</label>
                    <input type="file" id="videoFile" accept="video/*" required>
                </div>
                <div class="form-group">
                    <label>Analysis Type</label>
                    <select id="analysisType">
                        <option value="cv">Computer Vision (Fast)</option>
                        <option value="gpt">GPT Vision (Slower but more accurate)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Analysis Speed (FPS)</label>
                    <select id="fpsSelect">
                        <option value="0.5">0.5 FPS (Slow, High Accuracy)</option>
                        <option value="1.0" selected>1.0 FPS (Balanced)</option>
                        <option value="2.0">2.0 FPS (Fast, Lower Accuracy)</option>
                    </select>
                </div>
                <button type="submit" class="btn" id="uploadBtn">Upload & Analyze</button>
            </form>
        </div>
        
        <div class="progress-section" id="progressSection">
            <h3>Analysis in Progress...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">0% - Starting analysis...</p>
        </div>
        
        <div class="results-section" id="resultsSection">
            <h3>Analysis Results</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let progressInterval = null;

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('videoFile');
            const analysisType = document.getElementById('analysisType').value;
            const fps = document.getElementById('fpsSelect').value;
            
            if (!fileInput.files[0]) {
                alert('Please select a video file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('analysis_type', analysisType);
            formData.append('fps', fps);
            
            // Disable upload button
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadBtn').textContent = 'Uploading...';
            
            try {
                const response = await fetch('/upload-video', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    currentTaskId = result.task_id;
                    showProgress();
                    startProgressTracking();
                } else {
                    showStatus('Upload failed: ' + result.message, 'error');
                }
            } catch (error) {
                showStatus('Upload failed: ' + error.message, 'error');
            } finally {
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').textContent = 'Upload & Analyze';
            }
        });

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
        }

        function startProgressTracking() {
            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/analysis-progress/${currentTaskId}`);
                    const data = await response.json();
                    
                    updateProgress(data.progress, data.status);
                    
                    if (data.status === 'completed') {
                        clearInterval(progressInterval);
                        loadResults();
                    } else if (data.status === 'error') {
                        clearInterval(progressInterval);
                        showStatus('Analysis failed: ' + data.message, 'error');
                    }
                } catch (error) {
                    console.error('Progress tracking error:', error);
                }
            }, 2000);
        }

        function updateProgress(progress, status) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = progress + '%';
            progressText.textContent = `${progress}% - ${status}`;
        }

        async function loadResults() {
            try {
                const response = await fetch(`/analysis-results/${currentTaskId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayResults(data.results, data.type);
                } else {
                    showStatus('Failed to load results', 'error');
                }
            } catch (error) {
                showStatus('Failed to load results: ' + error.message, 'error');
            }
        }

        function displayResults(results, type) {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            const content = document.getElementById('resultContent');
            
            let html = `
                <div class="status status-success">
                    ‚úÖ Analysis completed successfully using ${type.toUpperCase()} method
                </div>
                <h4>Summary:</h4>
                <p><strong>Processed Frames:</strong> ${results.processed_frames || results.total_frames_processed}</p>
                <p><strong>Duration:</strong> ${results.duration?.toFixed(1) || results.video_duration?.toFixed(1)}s</p>
                <p><strong>Average Similarity:</strong> ${results.summary?.avg_similarity?.toFixed(3) || 'N/A'}</p>
                
                <h4>Top Similar Moments:</h4>
            `;
            
            const topFrames = results.top_frames || [];
            topFrames.slice(0, 5).forEach((frame, index) => {
                const score = frame.similarity || frame.similarity_score;
                const scoreClass = score > 0.7 ? 'score-high' : score > 0.4 ? 'score-medium' : 'score-low';
                
                html += `
                    <div class="result-item-with-images">
                        <div class="result-header">
                            <strong>#${index + 1}: Frame ${frame.frame_number} at ${frame.time?.toFixed(1)}s</strong>
                            <div class="similarity-score ${scoreClass}">
                                ${score?.toFixed(3) || 'N/A'}
                            </div>
                        </div>
                        ${frame.analysis ? `<p>${frame.analysis.substring(0, 100)}...</p>` : ''}
                        
                        <div class="image-comparison">
                            <div class="chart-side">
                                <h5>Left Chart</h5>
                                <img src="/results/${frame.left_path || 'left_' + String(frame.frame_number).padStart(6, '0') + '.jpg'}" 
                                     alt="Left Chart" onerror="this.style.display='none'">
                            </div>
                            <div class="chart-side">
                                <h5>Right Chart</h5>
                                <img src="/results/${frame.right_path || 'right_' + String(frame.frame_number).padStart(6, '0') + '.jpg'}" 
                                     alt="Right Chart" onerror="this.style.display='none'">
                            </div>
                        </div>
                        
                        ${frame.overlay_path ? `
                            <div class="overlay-section">
                                <h5>Overlay Comparison</h5>
                                <img src="/results/${frame.overlay_path}" alt="Overlay" class="overlay-img">
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }

        function showStatus(message, type) {
            const status = document.createElement('div');
            status.className = `status status-${type}`;
            status.textContent = message;
            document.querySelector('.container').insertBefore(status, document.querySelector('.upload-section').nextSibling);
            
            setTimeout(() => status.remove(), 5000);
        }
    </script>
</body>
</html>